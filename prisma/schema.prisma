generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum SubscriptionTier {
  FREE
  PRO
  ADMIN
}

enum SeasonType {
  REGULAR
  POSTSEASON
}

enum SpreadResult {
  COVERED
  LOST
  PUSH
}

enum OUResult {
  OVER
  UNDER
  PUSH
}

enum Conference {
  AFC
  NFC
}

enum Division {
  EAST
  WEST
  NORTH
  SOUTH
}

// ─── User ────────────────────────────────────────────────

model User {
  id                      String           @id @default(cuid())
  email                   String           @unique
  name                    String?
  username                String           @unique
  passwordHash            String
  emailVerified           Boolean          @default(false)
  verificationToken       String?
  resetToken              String?
  resetTokenExpiry        DateTime?
  failedLoginAttempts     Int              @default(0)
  lockedUntil             DateTime?
  subscriptionTier        SubscriptionTier @default(FREE)
  stripeCustomerId        String?          @unique
  stripeSubscriptionId    String?          @unique
  stripeSubscriptionStatus String?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
}

// ─── Team ────────────────────────────────────────────────

model Team {
  id           String     @id @default(cuid())
  name         String     @unique // e.g. "Kansas City Chiefs"
  abbreviation String     @unique // e.g. "KC"
  city         String     // e.g. "Kansas City"
  nickname     String     // e.g. "Chiefs"
  conference   Conference
  division     Division
  franchiseKey String     // Groups historical names, e.g. "Raiders" for OAK/LA/LV
  isActive     Boolean    @default(true)

  homeGames Game[] @relation("HomeTeam")
  awayGames Game[] @relation("AwayTeam")
  wonGames  Game[] @relation("Winner")

  @@index([franchiseKey])
}

// ─── Season ──────────────────────────────────────────────

model Season {
  id   String     @id @default(cuid())
  year Int        @unique
  type SeasonType @default(REGULAR)

  games Game[]

  @@index([year])
}

// ─── Game ────────────────────────────────────────────────

model Game {
  id         String   @id @default(cuid())
  seasonId   String
  season     Season   @relation(fields: [seasonId], references: [id])
  week       String   // "1"-"18", "WildCard", "Division", "ConfChamp", "SuperBowl"
  date       DateTime
  time       String?  // ET kickoff time
  dayOfWeek  String   // "Sun", "Mon", "Thu", etc.
  homeTeamId String
  homeTeam   Team     @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId String
  awayTeam   Team     @relation("AwayTeam", fields: [awayTeamId], references: [id])
  homeScore  Int
  awayScore  Int
  scoreDiff  Int      // homeScore - awayScore (positive = home win)
  winnerId   String?  // null for ties
  winner     Team?    @relation("Winner", fields: [winnerId], references: [id])
  primetime  String?  // "MNF", "SNF", "TNF", or null
  isPlayoff  Boolean  @default(false)

  // Quarter scores
  homeQ1     Int?
  homeQ2     Int?
  homeQ3     Int?
  homeQ4     Int?
  homeOT     Int?
  awayQ1     Int?
  awayQ2     Int?
  awayQ3     Int?
  awayQ4     Int?
  awayOT     Int?

  // Turnovers
  homeTurnovers      Int?
  awayTurnovers      Int?
  homeInterceptions  Int?
  awayInterceptions  Int?
  homeFumbles        Int?
  awayFumbles        Int?

  bettingLine BettingLine?
  weather     Weather?

  @@unique([date, homeTeamId, awayTeamId])
  @@index([date])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([seasonId, week])
}

// ─── BettingLine ─────────────────────────────────────────

model BettingLine {
  id            String        @id @default(cuid())
  gameId        String        @unique
  game          Game          @relation(fields: [gameId], references: [id])
  spread        Float?        // From home team perspective (negative = home favored)
  overUnder     Float?
  moneylineHome Int?
  moneylineAway Int?
  spreadResult  SpreadResult? // From home team perspective
  ouResult      OUResult?
  source        String        @default("pfr") // "pfr", "aussportsbetting", "odds-api"

  @@index([gameId])
}

// ─── ApiUsage ──────────────────────────────────────────

model ApiUsage {
  id       String   @id @default(cuid())
  sport    String   // "nfl", "ncaafb", "ncaamb"
  endpoint String   // e.g. "season_schedule", "weekly_schedule"
  calledAt DateTime @default(now())

  @@index([sport, calledAt])
}

// ─── CFB Team ──────────────────────────────────────────

model CfbTeam {
  id           String    @id @default(cuid())
  name         String    // e.g. "Alabama Crimson Tide"
  alias        String    @unique // e.g. "ALA"
  market       String    // e.g. "Alabama"
  mascot       String?   // e.g. "Crimson Tide"
  conference   String?   // e.g. "SEC", "Big Ten"
  srId         String?   @unique // Sportsradar ID
  isActive     Boolean   @default(true)

  homeGames CfbGame[] @relation("CfbHomeTeam")
  awayGames CfbGame[] @relation("CfbAwayTeam")

  @@index([conference])
}

// ─── CFB Season ────────────────────────────────────────

model CfbSeason {
  id   String @id @default(cuid())
  year Int    @unique
  type String @default("REG") // "REG", "PST"

  games CfbGame[]

  @@index([year])
}

// ─── CFB Game ──────────────────────────────────────────

model CfbGame {
  id         String    @id @default(cuid())
  seasonId   String
  season     CfbSeason @relation(fields: [seasonId], references: [id])
  week       String    // "1"-"15", "Playoff", "Bowl"
  date       DateTime
  time       String?
  dayOfWeek  String
  homeTeamId String
  homeTeam   CfbTeam   @relation("CfbHomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId String
  awayTeam   CfbTeam   @relation("CfbAwayTeam", fields: [awayTeamId], references: [id])
  homeScore  Int       @default(0)
  awayScore  Int       @default(0)
  scoreDiff  Int       @default(0)
  isPlayoff  Boolean   @default(false)
  srId       String?   @unique // Sportsradar game ID

  @@unique([date, homeTeamId, awayTeamId])
  @@index([seasonId, week])
  @@index([homeTeamId])
  @@index([awayTeamId])
}

// ─── CBB Team ──────────────────────────────────────────

model CbbTeam {
  id           String    @id @default(cuid())
  name         String    // e.g. "Duke Blue Devils"
  alias        String    @unique // e.g. "DUK"
  market       String    // e.g. "Duke"
  mascot       String?
  conference   String?   // e.g. "ACC", "Big Ten"
  srId         String?   @unique
  isActive     Boolean   @default(true)

  homeGames CbbGame[] @relation("CbbHomeTeam")
  awayGames CbbGame[] @relation("CbbAwayTeam")

  @@index([conference])
}

// ─── CBB Season ────────────────────────────────────────

model CbbSeason {
  id   String @id @default(cuid())
  year Int    @unique

  games CbbGame[]

  @@index([year])
}

// ─── CBB Game ──────────────────────────────────────────

model CbbGame {
  id            String    @id @default(cuid())
  seasonId      String
  season        CbbSeason @relation(fields: [seasonId], references: [id])
  date          DateTime
  time          String?
  dayOfWeek     String
  homeTeamId    String
  homeTeam      CbbTeam   @relation("CbbHomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId    String
  awayTeam      CbbTeam   @relation("CbbAwayTeam", fields: [awayTeamId], references: [id])
  homeScore     Int       @default(0)
  awayScore     Int       @default(0)
  scoreDiff     Int       @default(0)
  isTournament  Boolean   @default(false)
  tournamentRound String?  // "First Four", "Round of 64", "Round of 32", "Sweet 16", "Elite Eight", "Final Four", "Championship"
  srId          String?   @unique

  @@unique([date, homeTeamId, awayTeamId])
  @@index([seasonId])
  @@index([homeTeamId])
  @@index([awayTeamId])
}

// ─── Weather ─────────────────────────────────────────────

model Weather {
  id          String  @id @default(cuid())
  gameId      String  @unique
  game        Game    @relation(fields: [gameId], references: [id])
  temperature Int?    // Fahrenheit
  wind        String? // e.g. "12 mph"
  conditions  String? // e.g. "Clear", "Rain", "Snow"

  @@index([gameId])
}
